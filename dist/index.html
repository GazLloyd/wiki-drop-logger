<!DOCTYPE html>
<html>
	<head>
		<style>
			#Settings,
			body {
				display: none;
			}
		</style>
		<meta http-equiv="Permissions-Policy" content="interest-cohort=(), user-id=()" />
		<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
		<script>

			function RGBToGrayScale(red,green,blue){
				return (red * 6966 + green * 23436 + blue * 2366) >> 15;
			}

			function threshold(grayscale){
			const thresholdValue = 110;
				if (grayscale < thresholdValue) {
					return true;
				}else{
					return false;
				}
			}

			let reverseColors = ({data}) => {
				console.log(data)
				for (i = 0; i < data.length; i += 4) {
					data[i] = 255 - data[i];
					data[i + 1] = 255 - data[i + 1];
					data[i + 2] = 255 - data[i + 2];
					data[i + 3] = 255;
				}
				for (var i = 0; i < data.length; i += 4) {
				const red = data[i];
				const green = data[i + 1];
				const blue = data[i + 2];
				const grayscale = RGBToGrayScale(red, green, blue)
				if (threshold(grayscale)) {
					data[i] = 0;
					data[i + 1] = 0;
					data[i + 2] = 0;
				}else{
					data[i] = 255;
					data[i + 1] = 255;
					data[i + 2] = 255;
				}
				}
				return data
			}

			function readImage() {
				var input_image = document.getElementById('LootImage');
				const canvas = document.querySelector('#Canvas');
				const ctx = canvas.getContext('2d');
				ctx.drawImage(input_image, 0, 0);
				const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height)
				imgData.data = reverseColors(imgData)
				ctx.putImageData(imgData, 0, 0)
				ctx.scale(2, 2);
				input_image.setAttribute('src', 'data:image/png;base64,' + canvas.toDataURL())

				if (input_image.getAttribute('src').length > 0) {
				//const base64string = input_image.getAttribute('src').split(',')[1];
				Tesseract.recognize(canvas.toDataURL(), 'eng', { logger: m => console.log(m) }).then(({data: { text } } ) => {
					console.log(text);
					setTimeout(() => {
						readImage();
					}, 10000)

				});
			}
			}

			document.addEventListener('DOMContentLoaded', function(){
				setTimeout(() => {
					readImage();
				}, 10000)
			});

		</script>
	</head>
	<body id="app">
		<div id="output"></div>
		<div id="DropLog">
			<div id="Map">
				<h2>Map</h2>
			</div>
			<div id="Mob">
				<h2>NPC</h2>
			</div>
			<div id="Loot">
				<h2>Loot</h2>
				<img id="LootImage" src="">
			</div>
			<canvas id="Canvas" width="2000" height="2000"></canvas>
		</div>
		<div id="Settings">
			<div class="container">
			</div>
		</div>
		<script src="./main.js" defer></script>
	</body>
</html>
